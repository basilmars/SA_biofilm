# ??????????????? R ???
library(readxl)
library(dplyr)
library(clusterProfiler)
#library(org.Hs.eg.db)  # ???????????? ID ????????????????????????
library(enrichplot)    # ?????? gseaplot2
library(ggplot2)
library(cowplot)

# ??????????????????
rpkm_data <- read_excel("D:/NetDrive/OneDrive - wlulab/Work/??????/??????/MRSA biofilm vs HNP1/20241114 - RNAseq - 29213 VS HNP1/H_vs_S_with_gene_virulence.xlsx")

# ???????????????????????????
expression_data <- rpkm_data[, c("GeneID", "S29-1", "S29-2", "S29-3", "H29-1", "H29-2", "H29-3")]
expression_data <- as.data.frame(expression_data)
rownames(expression_data) <- expression_data$GeneID
expression_data <- expression_data[, -1]

# ??????????????????
expression_data <- as.data.frame(lapply(expression_data, as.numeric))

# ?????? log2 fold change
logFC <- rpkm_data$logFC

# ???????????????????????????
gene_rank <- logFC
names(gene_rank) <- rpkm_data$gene
gene_rank <- gene_rank[is.finite(gene_rank) & !is.na(names(gene_rank))]
gene_rank <- gene_rank[!duplicated(names(gene_rank))]
gene_rank <- sort(gene_rank, decreasing = TRUE)

# ????????????????????????
genes <- read_excel("./virulence_gene_data.xlsx")
gene_list <- as.character(genes$gene)  # ??????????????? "Gene"

# ?????? clusterProfiler ?????? GSEA
# clusterProfiler ??? GSEA ????????????????????? Entrez ID
# ?????????????????????????????? Entrez ID??????????????????
# ????????????????????????????????????????????????MRSA???????????????org.Hs.eg.db ?????????????????????
# ???????????????????????????????????????????????????????????? org.Sa.eg.db??????????????????
# ????????????????????????????????????????????????????????????????????????????????????

# ?????????????????????????????? GSEA?????????????????????????????????
gsea_res <- GSEA(
  geneList = gene_rank,
  TERM2GENE = data.frame(
    term = "Virulence-Related Genes",
    gene = gene_list
  ),
  pvalueCutoff = 1,
  minGSSize = 10,
  maxGSSize = 500,
  verbose = FALSE
)

# ?????? GSEA ??????
if (nrow(gsea_res) == 0) {
  stop("GSEA result is empty. Please check gene matching between gene_rank and biofilm_gene_list.")
}

# ?????? GSEA ???????????????????????????
p <- gseaplot2(
  gsea_res,
  geneSetID = 1,
  title = gsea_res$Description[1],
  subplots = 1:3,
  base_size = 10
)

# ?????????????????????
p[[1]] <- p[[1]] +
  theme(title = element_text(color = "black"))

# ????????????
print(p)

# ????????????
ggsave("gsea_plot_clusterProfiler.pdf", p, width = 8, height = 6)

#----?????????????????????-----------

if (!requireNamespace("devtools", quietly = TRUE))
  install.packages("devtools")
devtools::install_github("junjunlab/GseaVis")

library("GseaVis")

# ?????????????????????GseaVis ?????????
gsea_df <- as.data.frame(gsea_res)

# ?????? logFC ??????????????? 1 ??? FDR ?????? 0.05 ?????????
mygene <- c("lukG","eap","lukH","hlgA", "hlgC", "hlgB") #biofilm_genes %>%  filter(abs(logFC) > 1 & FDR < 0.05) %>%  pull(gene)  # ?????????????????????

# ?????? GseaVis ??????
num1 <- 1

# 1. ?????????????????????????????????????????????????????????????????????????????????
p1 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1]
)

# 2. ?????????????????????
p2 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 1
)

# 3. ???????????????????????????
p3 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 2
)

# 4. ???????????????????????????
p4 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 2,
  termWidth = 30
)

# 5. ????????????????????????
p5 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 2,
  addGene = mygene
)

# 6. ???????????????????????????????????????
p6 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 2,
  addGene = mygene,
  arrowType = 'open',
  geneCol = 'black'
)

# 7. ?????????????????????????????????
p7 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  subPlot = 3,
  addGene = mygene,
  rmSegment = TRUE
)

# 8. ????????????????????? p ???
p8 <- gseaNb(
  object = gsea_res,
  geneSetID = gsea_df$ID[num1],
  addGene = mygene,
  addPval = TRUE,
  pvalX = 0.75,
  pvalY = 0.8,
  pCol = 'black',
  pHjust = 0
)

# ???????????????????????????????????? p1???
print(p8)
